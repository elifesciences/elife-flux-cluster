apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: namespace-to-nodeselector
  annotations:
    policies.kyverno.io/title: Add nodeSelector and toleration to pods from namespace annotations
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/minversion: 1.6.0
spec:
  rules:
  - name: add-nodeselector
    match:
      any:
      - resources:
          kinds:
          - Pod
    context:
    - name: project
      apiCall:
        urlPath: "/api/v1/namespaces/{{request.namespace}}"
        jmesPath: "metadata.annotations.\"elifesciences.org/default-project\" || ''"
    preconditions:
      all:
      - key: "{{ project }}"
        operator: NotEquals
        value: ""
      - key: "{{ request.object.spec.nodeSelector.\"elifesciences.org/project\" || '' }}"
        operator: Equals
        value: ""
      - key: "{{ request.object.metadata.annotations.\"elifesciences.org/project\" || '' }}"
        operator: Equals
        value: ""
      - key: "{{ request.object.metadata.label.\"elifesciences.org/project\" || '' }}"
        operator: Equals
        value: ""
      - key: "{{ request.object.spec.tolerations[].key || [] }}"
        operator: AnyNotIn
        value:
        - "project"
    mutate:
      patchStrategicMerge:
        metadata:
          annotations:
            elifesciences.org/project: "{{ project }}"
          labels:
            elifesciences.org/project: "{{ project }}"
        spec:
          nodeSelector:
            elifesciences.org/project: "{{ project }}"
          tolerations:
          - key: project
            value: "{{ project }}"
            operator: "Equal"
            effect: "NoSchedule"
