apiVersion: templates.kluctl.io/v1alpha1
kind: ObjectTemplate
metadata:
  name: pr-envs
  namespace: epp--previews
spec:
  serviceAccountName: epp-previews
  prune: true
  matrix:
  - name: pr
    object:
      ref:
        apiVersion: templates.kluctl.io/v1alpha1
        kind: ListGithubPullRequests
        name: epp-preview-prs
      jsonPath: status.pullRequests
      expandLists: true
  templates:
  - object:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "epp--preview-{{ matrix.pr.number }}"
  - object:
      apiVersion: notification.toolkit.fluxcd.io/v1beta2
      kind: Provider
      metadata:
        name: epp-client-github-dispatch
        namespace: epp--preview-{{ matrix.pr.number }}
      spec:
        type: githubdispatch
        address: https://github.com/elifesciences/enhanced-preprints-client
        secretRef:
          name: github-api-token
  - object:
      apiVersion: notification.toolkit.fluxcd.io/v1beta2
      kind: Alert
      metadata:
        name: epp-deploy
        namespace: epp--preview-{{ matrix.pr.number }}
      spec:
        summary: "EPP deploy Preview for PR {{ matrix.pr.number }}"
        providerRef:
          name: epp-client-github-dispatch
        eventSeverity: info
        eventMetadata:
          github-pr: "{{ matrix.pr.number }}"
          github-statuses-url: "{{ matrix.pr.statuses_url }}"
        eventSources:
          - kind: Kustomization
            name: '*'
            namespace: epp--preview-{{ matrix.pr.number }}
  - object:
      apiVersion: kustomize.toolkit.fluxcd.io/v1
      kind: Kustomization
      metadata:
        name: epp--preview-{{ matrix.pr.number }}
        namespace: epp--preview-{{ matrix.pr.number }}
      spec:
        interval: 1m0s
        sourceRef:
          kind: GitRepository
          name: flux-system
          namespace: flux-system
        path: ./kustomizations/apps/epp/preview
        prune: true
        targetNamespace: epp--preview-{{ matrix.pr.number }}
        images:
          - name: ghcr.io/elifesciences/enhanced-preprints-client
            newTag: preview-{{ matrix.pr.number }}-{{ matrix.pr.head.sha }}
          - name: ghcr.io/elifesciences/enhanced-preprints-storybook
            newTag: preview-{{ matrix.pr.number }}-{{ matrix.pr.head.sha }}
        postBuild:
          substitute:
            app_env: epp--preview-{{ matrix.pr.number }}
            app_hostname: pr-{{ matrix.pr.number }}--epp.elifesciences.org
            storybook_hostname: pr-{{ matrix.pr.number }}--epp-storybook.elifesciences.org
            epp_server: http://epp-server.epp--staging:3000
            asset_prefix: https://pr-{{ matrix.pr.number }}--epp.elifesciences.org
            iiif_server: https://staging--epp.elifesciences.org/iiif
            client_replicas: "1"
            is_automated: "automated"
