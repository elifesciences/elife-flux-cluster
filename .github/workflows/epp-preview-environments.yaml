name: epp-preview-environments
on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'

jobs:
  create-epp-preview-envs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: master
          token: ${{ github.token }}
      - name: Run the script to create valid preview environments
        env:
          GH_TOKEN: ${{ github.token }}
        run: ./scripts/merge-epp-client-preview-prs.sh
        # Open a Pull Request if an upgraded is needed in production.
      - name: Open preview env PR
        id: create-pull-request
        uses: peter-evans/create-pull-request@v4
        with:
          add-paths: deployments/epp/previews
          branch: epp-previews
          delete-branch: true
          token: ${{ github.token }}
          commit-message: Create/update EPP preview environment
          title: Create/update EPP preview environment
          body: Create/update EPP preview environment
      - name: debug
        run: |
          echo "Pull Request Number - ${{ steps.create-pull-request.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.create-pull-request.outputs.pull-request-url }}"
          echo "Pull Request Operation - ${{ steps.create-pull-request.outputs.pull-request-operation }}"
          echo "Pull Request Head SHA - ${{ steps.create-pull-request.outputs.pull-request-head-sha }}"
      - name: Enable Pull Request Automerge
        if: steps.create-pull-request.outputs.pull-request-operation != 'closed' && steps.create-pull-request.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_BOT_TOKEN }}
        run:
          gh pr merge --admin --squash ${{ steps.create-pull-request.outputs.pull-request-number }}
      - name: debug
        if: failure()
        run: ls -lR deployments/epp/previews
