gcpProjectName: 'elife-data-pipeline'
importedTimestampFieldName: 'imported_timestamp'
webApi:

  #observer api
  - dataset: '{ENV}'
    table: published_dates
    dataUrl:
      urlExcludingConfigurableParameters: https://observer.elifesciences.org/report/published-article-index?format=json

  #elifescience people api
  - dataset: '{ENV}'
    table: people_staff_profile
    dataUrl:
      urlExcludingConfigurableParameters: https://api.elifesciences.org/people?
      configurableParameters:
        pageSizeParameterName: per-page
        defaultPageSize: 100
        pageParameterName: page
    response:
      itemsKeyFromResponseRoot:
        - items

  #elifescience profile api
  - dataset: '{ENV}'
    table: people_orcid_profile
    dataUrl:
      urlExcludingConfigurableParameters: https://api.elifesciences.org/profiles?
      configurableParameters:
        pageSizeParameterName: per-page
        defaultPageSize: 100
        pageParameterName: page
    response:
      itemsKeyFromResponseRoot:
        - items

  # hypothesis api (eLife journal)
  - dataset: '{ENV}'
    table: hypothesis_annotations
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-hypothesis-processing-state.json'
    dataUrl:
      urlExcludingConfigurableParameters: https://hypothes.is/api/search?group=imRGyeeV&sort=updated&order=asc
      configurableParameters:
        pageSizeParameterName: limit
        defaultPageSize: 100
        fromDateParameterName: search_after
        defaultStartDate: "2012-01-01T01:01:01.000000+00:00"
        dateFormat: "%Y-%m-%dT%H:%M:%S.%f%z"
    response:
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - updated
      itemsKeyFromResponseRoot:
        - rows

  # hypothesis api (public reviews)
  - dataset: '{ENV}'
    table: hypothesis_annotations
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-hypothesis-processing-state-q5X6RWJ6.json'
    dataUrl:
      urlExcludingConfigurableParameters: https://hypothes.is/api/search?group=q5X6RWJ6&sort=updated&order=asc
      configurableParameters:
        pageSizeParameterName: limit
        defaultPageSize: 100
        fromDateParameterName: search_after
        defaultStartDate: "2012-01-01T01:01:01.000000+00:00"
        dateFormat: "%Y-%m-%dT%H:%M:%S.%f%z"
    response:
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - updated
      itemsKeyFromResponseRoot:
        - rows

  #toggle api
  - dataset: '{ENV}'
    table: prod_raw_toggl
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-toggl-processing-state.json'
    dataUrl:
      urlExcludingConfigurableParameters: "https://api.track.toggl.com/reports/api/v2/details?workspace_id=3533142&user_agent=api_test&order_field=date&order_desc=off"
      configurableParameters:
        fromDateParameterName: since
        toDateParameterName: until
        defaultStartDate: "2019-07-01"
        dateFormat: "%Y-%m-%d"
        daysDiffFromStartTillEnd: 365
        pageParameterName: page
        defaultPageSize: 50
    response:
      itemsKeyFromResponseRoot:
        - data
      totalItemsCountKeyFromResponseRoot:
        - total_count
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - updated
    authentication:
      auth_type: basic
      orderedAuthenticationParamValues:
        - envVariableContainingPathToAuthFile: TOGGL_API_TOKEN_FILE_PATH
        - value: api_token

  # civi mailing
  - dataset: '{ENV}'
    table: civi_mailing_raw
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-civi-mailing-processing-state.json'
    urlSourceType:
      name: 'civi'
      sourceTypeSpecificValues:
        fieldsToReturn:
          - id
          - domain_id
          - header_id
          - name
          - open_tracking
          - mailing_type
          - is_archived
          - is_completed
          - approver_id
          - from_name
          - subject
          - url_tracking
          - from_email
          - modified_date
          - created_date
          - scheduled_date
          - campaign_id
          - approval_date
    dataUrl:
      urlExcludingConfigurableParameters: https://crm.elifesciences.org/crm/sites/all/modules/civicrm/extern/rest.php?entity=Mailing&action=get
      configurableParameters:
        #resultSortParameterName:
        resultSortParameterValue: modified_date
        fromDateParameterName: modified_date
        defaultStartDate: "2012-01-01 00:00:00"
        dateFormat: "%Y-%m-%d %H:%M:%S"
        pageSizeParameterName: limit
        defaultPageSize: 10000
        offsetParameterName: offset
      parametersFromFile:
        - parameterName: api_key
          filePathEnvName: CIVICRM_API_KEY_FILE_PATH
        - parameterName: key
          filePathEnvName: CIVICRM_SITE_KEY_FILE_PATH
    response:
      itemsKeyFromResponseRoot:
        - values
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - modified_date

  # civi export
  - dataset: '{ENV}'
    table: civi_contact_raw
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-civi-contact-processing-state.json'
    urlSourceType:
      name: 'civi'
      sourceTypeSpecificValues:
        fieldsToReturn:
          - external_identifier
          - tag
          - group
          - contact_type
          - contact_sub_type
          - last_name
          - first_name
          - middle_name
          - email
          - source
          - user_unique_id
          - organization_name
          - phone
          - city
          - modified_date
    dataUrl:
      urlExcludingConfigurableParameters: https://crm.elifesciences.org/crm/sites/all/modules/civicrm/extern/rest.php?entity=Contact&action=get
      configurableParameters:
        resultSortParameterValue: modified_date
        fromDateParameterName: modified_date
        defaultStartDate: "2012-01-01 00:00:00"
        dateFormat: "%Y-%m-%d %H:%M:%S"
        pageSizeParameterName: limit
        defaultPageSize: 10000
        offsetParameterName: offset
      parametersFromFile:
        - parameterName: api_key
          filePathEnvName: CIVICRM_API_KEY_FILE_PATH
        - parameterName: key
          filePathEnvName: CIVICRM_SITE_KEY_FILE_PATH
    response:
      itemsKeyFromResponseRoot:
        - values
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - modified_date

  # civi mailing recipients
  # note that the civi api does not have field modified_date for this entity
  # so the whole data  (> 17 million records) has to be downloaded at each run
  - dataset: '{ENV}'
    table: civi_mailing_recipient_raw
    tableWriteAppend: False
    urlSourceType:
      name: 'civi'
      sourceTypeSpecificValues:
        fieldsToReturn:
          - id
          - mailing_id
          - contact_id
    dataUrl:
      urlExcludingConfigurableParameters: https://crm.elifesciences.org/crm/sites/all/modules/civicrm/extern/rest.php?entity=MailingRecipients&action=get
      configurableParameters:
        pageSizeParameterName: limit
        defaultPageSize: 50000
        offsetParameterName: offset
      parametersFromFile:
        - parameterName: api_key
          filePathEnvName: CIVICRM_API_KEY_FILE_PATH
        - parameterName: key
          filePathEnvName: CIVICRM_SITE_KEY_FILE_PATH
    response:
      itemsKeyFromResponseRoot:
        - values

  # twitter user details
  - dataset: '{ENV}'
    table: twitter_user_details_of_sciety
    dataUrl:
      urlExcludingConfigurableParameters: https://api.twitter.com/1.1/users/show.json?include_entities=False&user_id=1295307136415735808
    headers:
      parametersFromFile:
        - parameterName: Authorization
          filePathEnvName: TWITTER_API_AUTHORIZATION_FILE_PATH

  # CrossRef Event Data (Cold Spring Harbor Laboratory: mainly bioRxiv, medRxiv)
  - dataset: '{ENV}'
    table: crossref_event_data_web_api
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-crossref-event-data-state-10.1101.json'
    dataUrl:
      urlExcludingConfigurableParameters: https://api.eventdata.crossref.org/v1/events?rows=100&mailto=h.ciplak@elifesciences.org&obj-id.prefix=10.1101
      configurableParameters:
        nextPageCursorParameterName: 'cursor'
        fromDateParameterName: 'from-collected-date'
        toDateParameterName: 'until-collected-date'
        daysDiffFromStartTillEnd: 1  # load data one day at a time
        defaultStartDate: '2017-01-01'
        dateFormat: '%Y-%m-%d'
    response:
      nextPageCursorKeyFromResponseRoot:
        - message
        - next-cursor
      itemsKeyFromResponseRoot:
        - message
        - events
      totalItemsCountKeyFromResponseRoot:
        - message
        - total-results
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - timestamp
