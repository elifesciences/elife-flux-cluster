gcpProjectName: 'elife-data-pipeline'
importedTimestampFieldName: 'imported_timestamp'
webApi:

  #observer api
  - dataset: '{ENV}'
    table: published_dates
    dataUrl:
      urlExcludingConfigurableParameters: https://observer.elifesciences.org/report/published-article-index?format=json

  #elifescience people api
  - dataset: '{ENV}'
    table: people_staff_profile
    dataUrl:
      urlExcludingConfigurableParameters: https://api.elifesciences.org/people?
      configurableParameters:
        pageSizeParameterName: per-page
        defaultPageSize: 100
        pageParameterName: page
    response:
      itemsKeyFromResponseRoot:
        - items

  #elifescience profile api
  - dataset: '{ENV}'
    table: people_orcid_profile
    dataUrl:
      urlExcludingConfigurableParameters: https://api.elifesciences.org/profiles?
      configurableParameters:
        pageSizeParameterName: per-page
        defaultPageSize: 100
        pageParameterName: page
    response:
      itemsKeyFromResponseRoot:
        - items

  # hypothesis api (eLife journal)
  - dataset: '{ENV}'
    table: hypothesis_annotations
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-hypothesis-processing-state.json'
    dataUrl:
      urlExcludingConfigurableParameters: https://hypothes.is/api/search?group=imRGyeeV&sort=updated&order=asc
      configurableParameters:
        pageSizeParameterName: limit
        defaultPageSize: 100
        fromDateParameterName: search_after
        defaultStartDate: "2012-01-01T01:01:01.000000+00:00"
        dateFormat: "%Y-%m-%dT%H:%M:%S.%f%z"
    response:
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - updated
      itemsKeyFromResponseRoot:
        - rows

  # hypothesis api (public reviews)
  - dataset: '{ENV}'
    table: hypothesis_annotations
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-hypothesis-processing-state-q5X6RWJ6.json'
    dataUrl:
      urlExcludingConfigurableParameters: https://hypothes.is/api/search?group=q5X6RWJ6&sort=updated&order=asc
      configurableParameters:
        pageSizeParameterName: limit
        defaultPageSize: 100
        fromDateParameterName: search_after
        defaultStartDate: "2012-01-01T01:01:01.000000+00:00"
        dateFormat: "%Y-%m-%dT%H:%M:%S.%f%z"
    response:
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - updated
      itemsKeyFromResponseRoot:
        - rows

  #toggle api
  - dataset: '{ENV}'
    table: prod_raw_toggl
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-toggl-processing-state.json'
    dataUrl:
      urlExcludingConfigurableParameters: "https://api.track.toggl.com/reports/api/v2/details?workspace_id=3533142&user_agent=api_test&order_field=date&order_desc=off"
      configurableParameters:
        fromDateParameterName: since
        toDateParameterName: until
        defaultStartDate: "2019-07-01"
        dateFormat: "%Y-%m-%d"
        daysDiffFromStartTillEnd: 365
        pageParameterName: page
        defaultPageSize: 50
    response:
      itemsKeyFromResponseRoot:
        - data
      totalItemsCountKeyFromResponseRoot:
        - total_count
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - updated
    authentication:
      auth_type: basic
      orderedAuthenticationParamValues:
        - envVariableContainingPathToAuthFile: TOGGL_API_TOKEN_FILE_PATH
        - value: api_token

  # civi mailing
  - dataset: '{ENV}'
    table: civi_mailing_raw
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-civi-mailing-processing-state.json'
    urlSourceType:
      name: 'civi'
      sourceTypeSpecificValues:
        fieldsToReturn:
          - id
          - domain_id
          - header_id
          - name
          - open_tracking
          - mailing_type
          - is_archived
          - is_completed
          - approver_id
          - from_name
          - subject
          - url_tracking
          - from_email
          - modified_date
          - created_date
          - scheduled_date
          - campaign_id
          - approval_date
    dataUrl:
      urlExcludingConfigurableParameters: https://crm.elifesciences.org/crm/sites/all/modules/civicrm/extern/rest.php?entity=Mailing&action=get
      configurableParameters:
        #resultSortParameterName:
        resultSortParameterValue: modified_date
        fromDateParameterName: modified_date
        defaultStartDate: "2012-01-01 00:00:00"
        dateFormat: "%Y-%m-%d %H:%M:%S"
        pageSizeParameterName: limit
        defaultPageSize: 10000
        offsetParameterName: offset
      parametersFromFile:
        - parameterName: api_key
          filePathEnvName: CIVICRM_API_KEY_FILE_PATH
        - parameterName: key
          filePathEnvName: CIVICRM_SITE_KEY_FILE_PATH
    response:
      itemsKeyFromResponseRoot:
        - values
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - modified_date

  # civi export
  - dataset: '{ENV}'
    table: civi_contact_raw
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-civi-contact-processing-state.json'
    urlSourceType:
      name: 'civi'
      sourceTypeSpecificValues:
        fieldsToReturn:
          - external_identifier
          - tag
          - group
          - contact_type
          - contact_sub_type
          - last_name
          - first_name
          - middle_name
          - email
          - source
          - user_unique_id
          - organization_name
          - phone
          - city
          - modified_date
    dataUrl:
      urlExcludingConfigurableParameters: https://crm.elifesciences.org/crm/sites/all/modules/civicrm/extern/rest.php?entity=Contact&action=get
      configurableParameters:
        resultSortParameterValue: modified_date
        fromDateParameterName: modified_date
        defaultStartDate: "2012-01-01 00:00:00"
        dateFormat: "%Y-%m-%d %H:%M:%S"
        pageSizeParameterName: limit
        defaultPageSize: 10000
        offsetParameterName: offset
      parametersFromFile:
        - parameterName: api_key
          filePathEnvName: CIVICRM_API_KEY_FILE_PATH
        - parameterName: key
          filePathEnvName: CIVICRM_SITE_KEY_FILE_PATH
    response:
      itemsKeyFromResponseRoot:
        - values
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - modified_date

  # civi mailing recipients
  # note that the civi api does not have field modified_date for this entity
  # so the whole data  (> 17 million records) has to be downloaded at each run
  - dataset: '{ENV}'
    table: civi_mailing_recipient_raw
    tableWriteAppend: False
    urlSourceType:
      name: 'civi'
      sourceTypeSpecificValues:
        fieldsToReturn:
          - id
          - mailing_id
          - contact_id
    dataUrl:
      urlExcludingConfigurableParameters: https://crm.elifesciences.org/crm/sites/all/modules/civicrm/extern/rest.php?entity=MailingRecipients&action=get
      configurableParameters:
        pageSizeParameterName: limit
        defaultPageSize: 50000
        offsetParameterName: offset
      parametersFromFile:
        - parameterName: api_key
          filePathEnvName: CIVICRM_API_KEY_FILE_PATH
        - parameterName: key
          filePathEnvName: CIVICRM_SITE_KEY_FILE_PATH
    response:
      itemsKeyFromResponseRoot:
        - values

  # twitter user details
  - dataset: '{ENV}'
    table: twitter_user_details_of_sciety
    dataUrl:
      urlExcludingConfigurableParameters: https://api.twitter.com/1.1/users/show.json?include_entities=False&user_id=1295307136415735808
    headers:
      parametersFromFile:
        - parameterName: Authorization
          filePathEnvName: TWITTER_API_AUTHORIZATION_FILE_PATH

  # Twitter API v2 Search: Preprints and Sciety
  - dataset: '{ENV}'
    table: twitter_api_v2_search_response
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: airflow-config/generic-web-api/state/twitter_api_v2_search/preprints-and-sciety.json
    dataUrl:
      # We are including DOI prefix and website host for preprint servers (e.g. researchsquare links won't contain DOI in URL)
      # Preprint servers:
      # - 10.1101: bioRxiv, medRxiv (Cold Spring Harbor Laboratory in general)
      # - 10.21203: Research Square (https://www.researchsquare.com/)
      # - 10.20944: Preprints.org
      # - 10.31234: PsyArXiv (https://psyarxiv.com/)
      # - 10.22541: Authorea Preprints (https://www.authorea.com)
      # - 10.2139: SSRN (https://papers.ssrn.com)
      urlExcludingConfigurableParameters: 'https://api.twitter.com/2/tweets/search/recent?query=("10.1101/" OR "biorxiv" OR "medrxiv" OR "10.21203/" OR "researchsquare.com" OR "10.20944/" OR "preprints.org" OR "10.31234/" OR "psyarxiv" OR "10.22541/" OR "authorea" OR "10.2139/" OR "ssrn.com" OR "sciety.org" OR @ScietyHQ)&tweet.fields=attachments,author_id,context_annotations,conversation_id,created_at,edit_controls,entities,geo,id,in_reply_to_user_id,lang,public_metrics,possibly_sensitive,referenced_tweets,reply_settings,source,text,withheld&place.fields=contained_within,country,country_code,full_name,geo,id,name,place_type&expansions=author_id,geo.place_id&max_results=100'
    configurableParameters:
      nextPageCursorParameterName: next_token
      fromDateParameterName: start_time
      toDateParameterName: end_time
      daysDiffFromStartTillEnd: 1
      defaultStartDate: 2023-02-04+00:00  # This can only be around 7 days in the past, otherwise it will fail
      dateFormat: "%Y-%m-%dT%H:%M:%SZ"
    headers:
      parametersFromFile:
        - parameterName: Authorization
          filePathEnvName: TWITTER_API_AUTHORIZATION_FILE_PATH
    response:
      nextPageCursorKeyFromResponseRoot:
      - meta
      - next_token
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
        - data
        - created_at

  # CrossRef Event Data (Cold Spring Harbor Laboratory: mainly bioRxiv, medRxiv)
  - dataset: '{ENV}'
    table: crossref_event_data_web_api
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-crossref-event-data-state-10.1101.json'
    schemaFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/crossref-event/data-schema/crossref-event-schema.json'
    dataUrl:
      urlExcludingConfigurableParameters: https://api.eventdata.crossref.org/v1/events?rows=100&mailto=h.ciplak@elifesciences.org&obj-id.prefix=10.1101
      configurableParameters:
        nextPageCursorParameterName: 'cursor'
        fromDateParameterName: 'from-collected-date'
        toDateParameterName: 'until-collected-date'
        daysDiffFromStartTillEnd: 1  # load data one day at a time
        defaultStartDate: '2017-01-01+00:00'
        dateFormat: '%Y-%m-%d'
    response:
      nextPageCursorKeyFromResponseRoot:
        - message
        - next-cursor
      itemsKeyFromResponseRoot:
        - message
        - events
      totalItemsCountKeyFromResponseRoot:
        - message
        - total-results
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - timestamp

  # bioRxiv/medRxiv MECA path metadata
  # http://api.biorxiv.org/meca_index/elife/help
  - dataset: '{ENV}'
    table: biorxiv_medrxiv_meca_path_metadata
    dataUrl:
      urlExcludingConfigurableParameters: https://api.biorxiv.org/meca_index/elife/all
  - dataset: '{ENV}'
    table: biorxiv_medrxiv_meca_path_metadata

  # bioRxiv/medRxiv apis
  # bioRxiv api
  - dataset: '{ENV}'
    table: 'biorxiv_medrxiv_api_response'
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-biorxiv-api-state.json'
    urlSourceType:
      name: 'biorxiv_medrxiv_api'
    dataUrl:
      urlExcludingConfigurableParameters: https://api.biorxiv.org/details/biorxiv
      configurableParameters:
        defaultPageSize: 100
        dateFormat: '%Y-%m-%d'
        defaultStartDate: '2013-11-06+00:00'
        daysDiffFromStartTillEnd: 15
    response:
      itemsKeyFromResponseRoot:
        - collection
      totalItemsCountKeyFromResponseRoot:
        - message
        - total
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - date
  # medRxiv api
  - dataset: '{ENV}'
    table: 'biorxiv_medrxiv_api_response'
    stateFile:
      bucketName: '{ENV}-elife-data-pipeline'
      objectName: 'airflow-config/generic-web-api/{ENV}-medrxiv-api-state.json'
    urlSourceType:
      name: 'biorxiv_medrxiv_api'
    dataUrl:
      urlExcludingConfigurableParameters: https://api.medrxiv.org/details/medrxiv
      configurableParameters:
        defaultPageSize: 100
        dateFormat: '%Y-%m-%d'
        defaultStartDate: '2019-06-25+00:00'
        daysDiffFromStartTillEnd: 15
    response:
      itemsKeyFromResponseRoot:
        - collection
      totalItemsCountKeyFromResponseRoot:
        - message
        - total
      recordTimestamp:
        itemTimestampKeyFromItemRoot:
          - date
