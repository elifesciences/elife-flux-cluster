twitterAdsApi:
  - dataPipelineId: twitter_ads_api_campaign_details_elife_journal
    source:
      resource: '/11/accounts/18ce53up4ko/campaigns'
      secrets:
        parametersFromFile:
          - parameterName: api_key
            filePathEnvName: TWITTER_API_KEY_FILE_PATH
          - parameterName: api_secret
            filePathEnvName: TWITTER_API_SECRET_FILE_PATH
          - parameterName: access_token
            filePathEnvName: TWITTER_ACCESS_TOKEN_FILE_PATH
          - parameterName: access_token_secret
            filePathEnvName: TWITTER_ACCESS_TOKEN_SECRET_FILE_PATH
    target:
      projectName: 'elife-data-pipeline'
      datasetName: '{ENV}'
      tableName: twitter_campaign_details_elife_journal

  - dataPipelineId: twitter_ads_api_campaign_reach_elife_journal
    source:
      resource: '/11/stats/accounts/18ce53up4ko/reach/campaigns'
      secrets:
        parametersFromFile:
          - parameterName: api_key
            filePathEnvName: TWITTER_API_KEY_FILE_PATH
          - parameterName: api_secret
            filePathEnvName: TWITTER_API_SECRET_FILE_PATH
          - parameterName: access_token
            filePathEnvName: TWITTER_ACCESS_TOKEN_FILE_PATH
          - parameterName: access_token_secret
            filePathEnvName: TWITTER_ACCESS_TOKEN_SECRET_FILE_PATH
      apiQueryParameters:
        parameterValues:
          fromBigQuery:
            projectName: 'elife-data-pipeline'
            sqlQuery: |-
              SELECT DISTINCT t_data.id AS entity_id, CAST(CAST(t_data.created_at AS DATE) AS STRING) AS start_date
              FROM `elife-data-pipeline.{ENV}.v_latest_twitter_campaign_details_elife_journal`
              JOIN UNNEST(data) AS t_data
              WHERE  -- the campaigns before '2015-01-02' has to be filtered because of api limits
              CAST(t_data.created_at AS DATE) > CAST('2015-01-02' AS DATE)
              -- AND t_data.effective_status = 'ACTIVE'
          maxPeriodInDays: 600
        parameterNamesFor:
          entityId: campaign_ids
          startDate: start_time
          endDate: end_time
    target:
      projectName: 'elife-data-pipeline'
      datasetName: '{ENV}'
      tableName: twitter_campaign_reach_elife_journal

  - dataPipelineId: twitter_ads_api_campaign_clicks_and_impressions_elife_journal
    source:
      resource: '/11/stats/accounts/18ce53up4ko?entity=CAMPAIGN&granularity=DAY&metric_groups=ENGAGEMENT'
      secrets:
        parametersFromFile:
          - parameterName: api_key
            filePathEnvName: TWITTER_API_KEY_FILE_PATH
          - parameterName: api_secret
            filePathEnvName: TWITTER_API_SECRET_FILE_PATH
          - parameterName: access_token
            filePathEnvName: TWITTER_ACCESS_TOKEN_FILE_PATH
          - parameterName: access_token_secret
            filePathEnvName: TWITTER_ACCESS_TOKEN_SECRET_FILE_PATH
      apiQueryParameters:
        parameterValues:
          fromBigQuery:
            projectName: 'elife-data-pipeline'
            # query has been filtered for now because of api rate limit 
            sqlQuery: |-
              SELECT DISTINCT t_data.id AS entity_id, CAST(CAST(t_data.created_at AS DATE) AS STRING) AS start_date
              FROM `elife-data-pipeline.{ENV}.v_latest_twitter_campaign_details_elife_journal`
              JOIN UNNEST(data) AS t_data
              WHERE -- the campaigns before '2015-01-02' has to be filtered because of api limits
              CAST(t_data.created_at AS DATE) > CAST('2015-01-02' AS DATE)
              AND t_data.id IN ('i61cm')
              -- AND t_data.effective_status = 'ACTIVE'
          maxPeriodInDays: 90
          periodBatchSizeInDays: 7  # 7 days is the max batch size for this api endpoint
          placementValue: ['PUBLISHER_NETWORK','ALL_ON_TWITTER']
        parameterNamesFor:
          entityId: entity_ids
          startDate: start_time
          endDate: end_time
          placement: placement
    target:
      projectName: 'elife-data-pipeline'
      datasetName: '{ENV}'
      tableName: twitter_campaign_clicks_and_impressions_elife_journal
