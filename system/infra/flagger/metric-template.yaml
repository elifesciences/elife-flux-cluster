---
# Needed due to ingress controller residing in different namespace than canaries
apiVersion: flagger.app/v1beta1
kind: MetricTemplate
metadata:
  name: request-success-rate--central-ing-controller
  namespace: infra
spec:
  provider:
    type: prometheus
    address: http://monitoring-prometheus-stac-prometheus.monitoring:9090
  query: >
    sum(
        rate(
          nginx_ingress_controller_requests{
            namespace="infra",
            ingress="{{ ingress }}",
            status!~"5.*"
          }[{{ interval }}]
        )
      )
      /
      sum(
        rate(
          nginx_ingress_controller_requests{
            namespace="infra",
            ingress="{{ ingress }}"
          }[{{ interval }}]
        )
      )
      * 100
