---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: temporal-database
  namespace: temporal

spec:
  interval: 1m
  releaseName: temporal-database
  chart:
    spec:
      chart: pxc-db
      version: 1.18.0
      sourceRef:
        kind: HelmRepository
        name: percona
        namespace: db-operator-system
      interval: 1m

  values:
    pause: false
    backup:
      enabled: true
      serviceAccountName: temporal-database
      storages:
        temporal-backups:
          type: s3
          s3:
            bucket: "${aws_backup_s3_bucket}/temporal/database"
            region: "${aws_region}"
            credentialsSecret: temporal-backup # See ExternalSecret below
      schedule:
        - name: "daily-backup"
          schedule: "0 0 * * *"
          storageName: temporal-backups
          retention:
            count: 30
            type: count
            deleteFromStorage: true
        - name: "monthly-backup"
          schedule: "0 1 1 * *"
          storageName: temporal-backups
          retention:
            count: 12
            type: count
            deleteFromStorage: true
    pxc:
      nodeSelector:
        kubernetes.io/arch: amd64
      # request certs with cert-manager, not helm charts
      certManager: true
      resources:
        requests:
          memory: 1.2Gi
          cpu: 200m
      persistence:
        storageClass: csi-ebs-gp3
        size: 70Gi
      readinessProbes:
        initialDelaySeconds: 300
        failureThreshold: 10
      livenessProbes:
        initialDelaySeconds: 300
        failureThreshold: 10
    haproxy:
      nodeSelector:
        kubernetes.io/arch: amd64
      annotations:
        cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
      resources:
        requests:
          memory: 25Mi
          cpu: 200m
    logcollector:
      resources:
        requests:
          memory: 15Mi
          cpu: 10m
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: temporal-backup
  namespace: temporal
spec:
  refreshInterval: 1h
  target:
    name: temporal-backup
    creationPolicy: Owner
  secretStoreRef:
    name: secret-store
    kind: ClusterSecretStore
  dataFrom:
  - extract:
      key: clusters/flux-prod/backup-credentials/temporal
